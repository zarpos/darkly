# -*- mode: ruby -*-
# vi: set ft=ruby :

# ─────────────────────────────────────────────────────────────
#  Darkly – BornToSec Web Security Challenge
#  Vagrant configuration for VirtualBox (Linux correction)
#
#  Requirements:
#    - VirtualBox installed
#    - Vagrant installed
#    - Darkly_i386.iso placed in this same directory (setup/)
#
#  Usage:
#    vagrant up      → creates and boots the Darkly VM
#    vagrant halt    → shuts down the VM
#    vagrant destroy → removes the VM entirely
# ─────────────────────────────────────────────────────────────

ISO_NAME  = "Darkly_i386.iso"
VM_NAME   = "Darkly_BornToSec"
DUMMY_BOX = "darkly-dummy"
VM_IP     = "192.168.56.128"

iso_path = File.expand_path(ISO_NAME, __dir__)

# ── Pre-flight: ISO must exist ───────────────────────────────
unless File.exist?(iso_path)
  abort <<~MSG

    \e[31m[ERROR]\e[0m #{ISO_NAME} not found.
    Please download it from the 42 intra and place it here:
      #{iso_path}

  MSG
end

# ── Bootstrap: create a local dummy box if needed ───────────
unless ENV['DARKLY_BOX_CREATED'] == 'true' || `vagrant box list`.include?(DUMMY_BOX)
  ENV['DARKLY_BOX_CREATED'] = 'true'

  puts "\e[33m[setup]\e[0m Registering local dummy box '#{DUMMY_BOX}'..."
  require "tmpdir"

  Dir.mktmpdir do |tmp|
    File.write("#{tmp}/metadata.json", '{"provider":"virtualbox"}')

    File.write("#{tmp}/box.ovf", <<~OVF)
      <?xml version="1.0"?>
      <Envelope ovf:version="1.0" xml:lang="en-US"
        xmlns="http://schemas.dmtf.org/ovf/envelope/1"
        xmlns:ovf="http://schemas.dmtf.org/ovf/envelope/1">
        <VirtualSystem ovf:id="vm">
          <Info>A minimal VM</Info>
        </VirtualSystem>
      </Envelope>
    OVF

    Dir.chdir(tmp) do
      system("tar", "czf", "dummy.box", "metadata.json", "box.ovf")
    end

    if File.exist?("#{tmp}/dummy.box")
      system("vagrant", "box", "add", "--name", DUMMY_BOX, "#{tmp}/dummy.box", "--force")
      puts "\e[32m[setup]\e[0m Dummy box ready."
    else
      abort "\e[31m[ERROR]\e[0m Could not create dummy box file."
    end
  end
end

# ── Vagrant configuration ────────────────────────────────────
Vagrant.configure("2") do |config|

  config.vm.box          = DUMMY_BOX
  config.vm.communicator = :none
  config.vm.boot_timeout = 0
  config.ssh.insert_key  = false
  config.vm.network "private_network", ip: VM_IP, auto_config: false

  config.vm.provider "virtualbox" do |vb|

    vb.name   = VM_NAME
    vb.memory = 1024
    vb.cpus   = 1
    vb.gui    = true

    vb.customize ["modifyvm", :id, "--ostype",            "Debian"]
    vb.customize ["modifyvm", :id, "--pae",               "on"]
    vb.customize ["modifyvm", :id, "--vram",              "16"]
    vb.customize ["modifyvm", :id, "--graphicscontroller","vboxvga"]
    vb.customize ["modifyvm", :id, "--firmware",          "bios"]
    vb.customize ["modifyvm", :id, "--accelerate3d",      "off"]

    # ── Storage ───────────────────────────────────────────
    vb.customize ["storagectl", :id,
                  "--name", "IDE Controller",
                  "--add", "ide",
                  "--controller", "PIIX4"]
    vb.customize ["storageattach", :id,
                  "--storagectl", "IDE Controller",
                  "--port", "0", "--device", "0",
                  "--type", "dvddrive",
                  "--medium", iso_path]

    # ── Boot order ────────────────────────────────────────
    vb.customize ["modifyvm", :id,
                  "--boot1", "dvd",
                  "--boot2", "none",
                  "--boot3", "none",
                  "--boot4", "none"]

    # ── Misc optimisations ────────────────────────────────
    vb.customize ["modifyvm", :id, "--usb",   "off"]
    vb.customize ["modifyvm", :id, "--audio", "none"]

  end

  config.vm.post_up_message = <<~MSG

    \e[32m✔ Darkly VM is running!\e[0m
    Open your browser and navigate to:

        http://#{VM_IP}

    To stop the VM:   vagrant halt
    To destroy it:    vagrant destroy

  MSG

end
